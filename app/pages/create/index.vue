<script setup lang="ts">
import axios from 'axios';

import HeaderBackRoute from '~/share/components/HeaderBaskRoute.vue/index.vue';
import CustomImageInput from '~/modules/create/components/CustomImageInput/index.vue';
import productFormSchema from '~/modules/create/schemas/productFormSchema';
import CustomSelect, { type options } from '~/modules/create/components/CustomSelect/index.vue';
import CustomInput from '~/modules/create/components/CustomInput/index.vue';
import CustomQuantity from '~/modules/create/components/CustomQuantity/index.vue';
import PrimaryButton from '~/share/components/PrimaryButton/index.vue';

import { useField, useForm, validate } from 'vee-validate';
import { toast } from 'vue3-toastify';
import type { RequestCategoryType } from '~/modules/create/types/request-categorys';
import type { RequestProductType } from '~/modules/create/types/request-product-types';

const dataCategory = ref<RequestCategoryType[]>([]);
const optionsCategorys = ref<options[]>([]);
const optionsSubCategorys = ref<options[]>([]);
const productTypes = ref<options[]>([]);

const { handleSubmit } = useForm({
  validationSchema: productFormSchema,
  initialValues: {
    quantity: 1,
  },
});

const { value: category, errorMessage: categoryFormError } = useField('category');
const { value: subCategory, errorMessage: subCategoryFormError } = useField('subCategory');
const { value: productName, errorMessage: productNameFormError } = useField('productName');
const { value: type, errorMessage: typeFormError } = useField('type');
const { value: price, errorMessage: priceFormError } = useField('price');
const { value: quantity, errorMessage: quantityFormError } = useField('quantity');

const onSubmit = handleSubmit((values) => {
  console.log(values);
});

const getCategorys = async () => {
  try {
    const { data } = await axios.get<RequestCategoryType[]>('/api/category');
    optionsCategorys.value = data?.map((item, index) => {
      return {
        label: item.category,
        value: item.category,
      };
    });

    dataCategory.value = data;
  } catch (error) {
    toast.error('Ops! Ocorreu um erro no carregamentos algumas categorias');
  }
};

const getProductTypes = async () => {
  const { data } = await axios.get<RequestProductType[]>('/api/product-types');

  const options = data.map((item) => {
    return {
      label: item.tipo,
      value: item.sigla,
    };
  });

  productTypes.value = options ?? [];
};

watch(category, () => {
  if (category.value) {
    const selectedCategory = dataCategory.value.find((cat) => cat.category === category.value);
    const listSubCategory = selectedCategory?.subCategorys?.map((item) => {
      return {
        label: item,
        value: item,
      };
    });

    optionsSubCategorys.value = listSubCategory ?? [];
  }
});

onMounted(() => {
  getCategorys();
  getProductTypes();
});
</script>

<template>
  <main class="flex flex-col gap-10 p-5">
    <HeaderBackRoute label="Criando Lista" />

    <form class="flex flex-col gap-5" @submit.prevent="onSubmit">
      <CustomSelect
        v-model="category"
        label="Selecione a categoria do produto"
        name="productCategory"
        :error="categoryFormError"
        placeholder="Selecione uma categoria."
        :options="optionsCategorys"
      />

      <CustomSelect
        v-model="subCategory"
        label="Selecione uma subcategoria do produto"
        name="productSubCategory"
        :error="subCategoryFormError"
        placeholder="Selecione uma subcategoria."
        :options="optionsSubCategorys"
        :disabled="optionsSubCategorys.length === 0"
      />

      <CustomInput
        v-model="productName"
        label="Nome do produto"
        name="productName"
        placeholder="e.g Milho verde em conserva"
        :error="productNameFormError"
      />

      <CustomSelect
        v-model="type"
        label="Tipo"
        name="productTipo"
        :error="typeFormError"
        placeholder="Selecione um tipo"
        :options="productTypes"
      />

      <div class="flex gap-4 w-full">
        <CustomQuantity name="quantity" label="Quantidade" v-model="quantity" :error="quantityFormError" />

        <CustomInput
          label="PreÃ§o"
          name="price"
          v-model="price"
          :error="priceFormError"
          variant="price"
          autocomplete="off"
        />
      </div>

      <CustomImageInput :limitMbSize="1" />

      <PrimaryButton type="submit" label="Adicionar item" />
    </form>
  </main>
</template>
